// Generated by CoffeeScript 1.6.3
(function() {
  var ENTER, csrfToken,
    __bind = function(fn, me){ return function(){ return fn.apply(me, arguments); }; },
    __hasProp = {}.hasOwnProperty,
    __extends = function(child, parent) { for (var key in parent) { if (__hasProp.call(parent, key)) child[key] = parent[key]; } function ctor() { this.constructor = child; } ctor.prototype = parent.prototype; child.prototype = new ctor(); child.__super__ = parent.prototype; return child; };

  $.query = function(query_data) {
    return {
      data: JSON.stringify(query_data || {}),
      contentType: 'application/json'
    };
  };

  $.fn.htmlTemplate = function() {
    return this.html().trim();
  };

  $.getCookies = function() {
    var attr_name, cookie, cookies, value, _i, _len, _ref, _ref1;
    cookies = {};
    _ref = document.cookie.split('; ');
    for (_i = 0, _len = _ref.length; _i < _len; _i++) {
      cookie = _ref[_i];
      _ref1 = cookie.split('='), attr_name = _ref1[0], value = _ref1[1];
      cookies[attr_name] = value;
    }
    return cookies;
  };

  $.setCookie = function(name, value) {
    return document.cookie = "" + name + "=" + value;
  };

  $.getCookie = function(name) {
    return $.getCookies()[name];
  };

  $.fn.setChecked = function(value) {
    if (value) {
      return this.attr('checked', 'checked');
    } else {
      return this.removeAttr('checked');
    }
  };

  csrfToken = $.getCookie('csrftoken');

  $(document).ajaxSend(function(e, xhr, settings) {
    return xhr.setRequestHeader('X-CSRFToken', csrfToken);
  });

    if (typeof Spine !== "undefined" && Spine !== null) {
    Spine.FormController = (function(_super) {
      __extends(FormController, _super);

      FormController.prototype.elements = {
        '[name]': 'fields',
        '.control-group': 'control_groups'
      };

      FormController.prototype.get_field = function(name) {
        return this.fields.filter("[name=" + name + "]");
      };

      function FormController() {
        this.on_saved = __bind(this.on_saved, this);
        this.save = __bind(this.save, this);
        this.submit = __bind(this.submit, this);
        this.populate_instance = __bind(this.populate_instance, this);
        this.populate_fields = __bind(this.populate_fields, this);
        this.reset_form = __bind(this.reset_form, this);
        this.hide_errors = __bind(this.hide_errors, this);
        this.show_errors = __bind(this.show_errors, this);
        FormController.__super__.constructor.apply(this, arguments);
        this.el.submit(this.submit);
        this.init_instance();
      }

      FormController.prototype.init_instance = function(options) {
        if ((options != null ? options.instance : void 0) != null) {
          this.instance = options.instance;
        }
        if (options != null ? options.force : void 0) {
          this.instance = new this.Model;
        } else {
          if (this.instance == null) {
            this.instance = new this.Model;
          }
        }
        this.populate_fields();
        return this.bind_instance();
      };

      FormController.prototype.bind_instance = function() {
        this.instance.bind('ajaxError', this.show_errors);
        return this.instance.bind('ajaxSuccess', this.on_saved);
      };

      FormController.prototype.unbind_instance = function() {
        this.instance.unbind('ajaxError', this.show_errors);
        return this.instance.unbind('ajaxSuccess', this.on_saved);
      };

      FormController.prototype.show_errors = function(_instance, xhr) {
        var errors, instance, parse_error_response, restore_instance_state, show_errors, _ref,
          _this = this;
        parse_error_response = function(xhr) {
          var SyntaxError, error_data;
          try {
            error_data = JSON.parse(xhr.responseText);
            if (!'errors' in error_data || !'instance' in error_data) {
              throw SyntaxError;
            }
          } catch (_error) {
            SyntaxError = _error;
            alert('Error: there is a communication error!');
            throw SyntaxError;
          }
          return [error_data.instance, error_data.errors];
        };
        _ref = parse_error_response(xhr), instance = _ref[0], errors = _ref[1];
        (restore_instance_state = function() {
          if (_this.instance.cid === _this.instance.id) {
            _this.instance.id = null;
          }
          return _this.instance = _.extend(_this.instance, instance);
        })();
        return (show_errors = function() {
          var attr, msg, _results;
          if (errors.__all__ != null) {
            _this.el.prepend("<div class=\"alert hide alert-error text-center\">\n    " + errors.__all__ + "\n</div>");
            _this.$('.alert').slideDown();
          }
          _results = [];
          for (attr in errors) {
            msg = errors[attr];
            _results.push((_this.get_field(attr)).parents('.control-group').addClass('error').tooltip({
              title: msg
            }).tooltip('show'));
          }
          return _results;
        })();
      };

      FormController.prototype.hide_errors = function() {
        (this.control_groups.removeClass('error')).tooltip('destroy');
        return this.$('.alert').slideUp('fast', function() {
          return this.remove();
        });
      };

      FormController.prototype.reset_form = function() {
        this.fields.val('');
        return this.hide_errors();
      };

      FormController.prototype.populate_fields = function() {
        var attr, _i, _len, _ref, _results;
        this.reset_form();
        _ref = this.instance.attributes();
        _results = [];
        for (_i = 0, _len = _ref.length; _i < _len; _i++) {
          attr = _ref[_i];
          _results.push((this.get_field(attr)).val(this.instance[attr]));
        }
        return _results;
      };

      FormController.prototype.populate_instance = function() {
        var $field, field, modified, name, value, _i, _len, _ref;
        modified = false;
        _ref = this.fields;
        for (_i = 0, _len = _ref.length; _i < _len; _i++) {
          field = _ref[_i];
          $field = $(field);
          name = $field.attr('name');
          if (field.contentEditable === 'true') {
            value = $field.html().trim();
          } else {
            value = $field.val();
          }
          if (this.instance[name] !== value) {
            this.instance[name] = value;
            modified = true;
          }
        }
        return modified;
      };

      FormController.prototype.submit = function(e) {
        if (e != null) {
          if (typeof e.preventDefault === "function") {
            e.preventDefault();
          }
        }
        return this.save();
      };

      FormController.prototype.save = function() {
        if (this.populate_instance()) {
          this.hide_errors();
          return this.instance.save();
        }
      };

      FormController.prototype.on_saved = function(_instance, server_data) {
        var _ref;
        this.reset_form();
        this.instance = _.extend(this.instance, server_data);
        this.unbind_instance();
        return (_ref = this.parent) != null ? typeof _ref.hide === "function" ? _ref.hide() : void 0 : void 0;
      };

      return FormController;

    })(Spine.Controller);
  };

  ENTER = 13;

    if (typeof Spine !== "undefined" && Spine !== null) {
    Spine.ItemController = (function(_super) {
      __extends(ItemController, _super);

      ItemController.prototype.events = {
        'keydown [contenteditable][name]': 'trigger_field_change',
        'blur [contenteditable][name]': 'trigger_field_change',
        'change [name]': 'save'
      };

      function ItemController() {
        this.unbind_instance = __bind(this.unbind_instance, this);
        this.reset_form = __bind(this.reset_form, this);
        this.populate_fields = __bind(this.populate_fields, this);
        this.render = __bind(this.render, this);
        this.destroy = __bind(this.destroy, this);
        this.trigger_field_change = __bind(this.trigger_field_change, this);
        this.bind_instance = __bind(this.bind_instance, this);
        ItemController.__super__.constructor.apply(this, arguments);
      }

      ItemController.prototype.bind_instance = function() {
        ItemController.__super__.bind_instance.apply(this, arguments);
        this.instance.bind('update', this.render);
        return this.instance.bind('destroy', this.destroy);
      };

      ItemController.prototype.trigger_field_change = function(e) {
        if (e.keyCode === ENTER) {
          e.preventDefault();
        }
        if (e.type === 'focusout' || e.keyCode === ENTER) {
          return $(e.target).trigger('change');
        }
      };

      ItemController.prototype.destroy = function() {
        return this.el.fadeOut('fast', this.release);
      };

      ItemController.prototype.render = function() {
        return this.replace(this.template(this.instance));
      };

      ItemController.prototype.populate_fields = function() {};

      ItemController.prototype.reset_form = function() {};

      ItemController.prototype.unbind_instance = function() {};

      return ItemController;

    })(Spine.FormController);
  };

    if (typeof Spine !== "undefined" && Spine !== null) {
    Spine.ModalController = (function(_super) {
      __extends(ModalController, _super);

      ModalController.prototype.elements = {
        '.title': 'title',
        '.modal-body': 'body',
        '[name]:visible': 'first_visible_field'
      };

      ModalController.prototype.events = {
        'click .cancel': 'hide',
        'click .save': 'save'
      };

      function ModalController() {
        this.save = __bind(this.save, this);
        this.shown = __bind(this.shown, this);
        this.hidden = __bind(this.hidden, this);
        this.hide = __bind(this.hide, this);
        this.show = __bind(this.show, this);
        ModalController.__super__.constructor.apply(this, arguments);
        this.el.on('hidden', this.hidden);
        this.el.on('shown', this.shown);
        this.body_controller = new this.BodyController({
          parent: this,
          el: this.body
        });
      }

      ModalController.prototype.show = function(title, options) {
        if (title != null) {
          this.title.html(title);
        }
        this.body_controller.init_instance(options);
        return this.el.modal('show');
      };

      ModalController.prototype.hide = function() {
        return this.el.modal('hide');
      };

      ModalController.prototype.hidden = function() {
        return this.body_controller.init_instance({
          force: true
        });
      };

      ModalController.prototype.shown = function() {
        return this.$('[name]:visible').focus();
      };

      ModalController.prototype.save = function() {
        var _ref;
        return (_ref = this.body_controller) != null ? typeof _ref.save === "function" ? _ref.save() : void 0 : void 0;
      };

      return ModalController;

    })(Spine.Controller);
  };

}).call(this);

/*
//@ sourceMappingURL=helpers.map
*/
